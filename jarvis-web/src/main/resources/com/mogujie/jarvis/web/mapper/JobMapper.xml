<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.mogujie.jarvis.web.mapper.JobMapper">

    <sql id="condition">
      <where>
          <if test="jobId!=null">
              jobId=#{jobId}
          </if>
          <if test="jobName!=null and jobName!='' and jobName!='all'">
              AND jobName=#{jobName}
          </if>
          <if test="jobType!=null and jobType!='' and jobType!='all'">
              AND jobType=#{jobType}
          </if>
          <if test="status!=null">
              AND job.status=#{status}
          </if>
          <if test="submitUser!=null and submitUser!='' and submitUser!='all' ">
              AND submitUser=#{submitUser}
          </if>
          <if test="priority!=null">
              AND priority=#{priority}
          </if>
          <if test="appId!=null">
              AND appId=#{appId}
          </if>
          <if test="workerGroupId!=null">
              AND workerGroupId=#{workerGroupId}
          </if>

      </where>
    </sql>
    <sql id="pager">
        <if test="offset!=null and limit!=null">
          limit #{offset},#{limit}
        </if>
    </sql>
    
    <select id="getCountByCondition" parameterType="JobQo" resultType="Integer">
      SELECT COUNT(1) FROM job
      <include refid="condition" />
    </select>

    <select id="getJobsByCondition" parameterType="JobQo" resultType="JobVo">
      SELECT
        job.*,app.appName,
        app.appKey,
        job_schedule_expression.expressionType,
        job_schedule_expression.expression,
        worker_group.name AS workerGroupName
      FROM job
        LEFT JOIN app ON job.appId=app.appId
          LEFT JOIN job_schedule_expression ON job.jobId=job_schedule_expression.jobId
            LEFT JOIN worker_group ON job.workerGroupId=worker_group.id
      <include refid="condition" />
      ORDER BY job.jobId ASC
      <include refid="pager" />
    </select>

    <select id="getJobById" parameterType="Long" resultType="JobVo">
        SELECT job.*,job_schedule_expression.expressionType,job_schedule_expression.expression
        FROM job LEFT JOIN job_schedule_expression ON job.jobId=job_schedule_expression.jobId
        WHERE job.jobId=#{jobId} limit 0,1
    </select>

    <select id="getJobByName" parameterType="String" resultType="JobVo">
        SELECT * FROM job WHERE jobName=#{_parameter} limit 0,1
    </select>

    <select id="getJobIds" resultType="Long">
      SELECT DISTINCT jobId FROM job;
    </select>
    
    <select id="getJobNames" resultType="String">
      SELECT DISTINCT jobName FROM job;
    </select>

    <select id="getSubmitUsers" resultType="String">
      SELECT DISTINCT submitUser FROM job;
    </select>

    <select id="getSimilarJobIds" parameterType="Long" resultType="Long">
      SELECT DISTINCT jobId FROM job
      <where>
          <if test="_parameter!=null">
              jobId LIKE '%${_parameter}%'
          </if>
      </where>
    </select>

    <select id="getSimilarJobNames" parameterType="String" resultType="String">
      SELECT DISTINCT jobName FROM job
      <where>
          <if test="_parameter!=null and _parameter!=''">
              jobName LIKE '%${_parameter}%'
          </if>
      </where>
    </select>

    <select id="getJobBySimilarNames" parameterType="String" resultType="JobVo">
        SELECT DISTINCT * FROM job
        <where>
            <if test="_parameter!=null and _parameter!=''">
                jobName LIKE '%${_parameter}%'
            </if>
        </where>
    </select>

    
    <select id="getJobByIds"  resultType="JobVo">
        SELECT * FROM job WHERE jobId IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
    </select>

</mapper>